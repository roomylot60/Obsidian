# 도커 컴포즈 없이 Shell 스크립트로 2개의 컨테이너를 네트워크로 묶는 방법

## 1. 개요
도커 컴포즈를 사용하지 않아도 **사용자 정의 도커 네트워크(bridge network)** 를 생성하고  
두 컨테이너를 해당 네트워크에 연결하면 컨테이너 간 통신이 가능합니다.  
컨테이너 내부에서는 서로를 **컨테이너 이름으로 DNS 접근**할 수 있습니다.

---

## 2. 사용자 정의 네트워크 생성

```bash
docker network create app-net
```
- 네트워크는 한 번만 생성하면 지속적으로 재사용 가능.
- 컨테이너 이름 기반 접근(예: `http://vllm-api:8000`)이 가능해짐.

## 3. 네트워크 연결된 컨테이너 실행 예시
### 3.1 vLLM API 컨테이너 실행
```bash
docker run -d \
  --name vllm-api \
  --network app-net \
  -p 8000:8000 \
  vllm/vllm-openai:v0.8.3 \
  python -m vllm.entrypoints.openai.api_server \
    --model /models/gemma-3-12b-it \
    --host 0.0.0.0 \
    --port 8000
```
### 3.2 FastAPI 요약 컨테이너 실행
```bash
docker run -d \
  --name summary-api \
  --network app-net \
  -p 41795:8000 \
  my/summary-fastapi:latest
```
- summary-api 내부에서 `http://vllm-api:8000` 로 접근 가능.

## 4. Shell 스크립트로 자동화한 실행 예시
```bash
#!/bin/bash
set -euo pipefail

NETWORK_NAME="app-net"

# 1) 네트워크 생성
if ! docker network ls --format '{{.Name}}' | grep -q "^${NETWORK_NAME}\$"; then
  docker network create "${NETWORK_NAME}"
fi

# 2) 기존 컨테이너 제거
for c in vllm-api summary-api; do
  if docker ps -a --format '{{.Names}}' | grep -q "^${c}\$"; then
    docker rm -f "${c}"
  fi
done

# 3) vLLM 컨테이너 실행
docker run -d \
  --name vllm-api \
  --network "${NETWORK_NAME}" \
  -p 8000:8000 \
  --gpus all \
  vllm/vllm-openai:v0.8.3 \
  python -m vllm.entrypoints.openai.api_server \
    --model /models/gemma-3-12b-it \
    --host 0.0.0.0 \
    --port 8000

# 4) summary-api 컨테이너 실행
docker run -d \
  --name summary-api \
  --network "${NETWORK_NAME}" \
  -p 41795:8000 \
  my/summary-fastapi:latest
```

## 5. 이미 실행 중인 컨테이너를 네트워크에 연결하기
```bash
docker network create app-net

docker network connect app-net vllm-api
docker network connect app-net summary-api
```
- 이후 이름 기반 통신 가능: `http://vllm-api:8000`

## 6. 기타 연결 방식
### 6.1 포트 매핑 기반 통신
- 네트워크를 묶지 않아도 -p 로 호스트 포트만 열어 통신 가능.
- 컨테이너 B → `http://<host_ip>:8000`

### 6.2 --link (구식 / 비추천)
```bash
docker run -d --name summary-api --link vllm-api:vllm-api my/summary-fastapi
```

### 6.3 멀티 서버 연결
Docker Swarm/K8s 또는 외부 L4/Nginx LB 구조 필요.

## 7. 핵심 요약
- 도커 컴포즈 없이도 Shell + docker network + docker run 조합으로 컨테이너 2개를 같은 네트워크에 묶을 수 있음.
- 네트워크를 생성하고 두 컨테이너를 `--network` 로 연결하면 됨.
- 컨테이너끼리는 컨테이너 이름으로 직접 접근 가능.
