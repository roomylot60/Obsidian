# MySQL Replication

## MySQL 자체 기능

| 기능                 | 역할                        |
| -------------------- | --------------------------- |
| TCP 통신 프로토콜    | 서버 간 네트워크 연결       |
| MySQL 인증 기능      | Replica가 Source에 로그인   |
| Binlog 기록          | 변경 이벤트 저장            |
| Binlog 전송 프로토콜 | 이벤트를 안전하게 전송      |
| I/O Thread           | 원격 binlog 다운로드        |
| Relay Log            | 받은 이벤트 저장            |
| SQL Thread           | 이벤트 실행하여 데이터 반영 |

## 운영 편의를 위한 추가 도구

- Orchestrator (Replica 자동 Failover 관리 도구)
- MHA(Master High Availability)
- ProxySQL (읽기/쓰기 분리용 Proxy)
- Percona Toolkit (복제 검사 도구)

## MySQL에서의 서버간 통신: 클라이언트 ↔ 서버

- MySQL 프로토콜(TCP 기반)
- 계정 인증 기능(MySQL 자체 계정 / 비밀번호)
- 포트(기본 3306) 열기
- 원격 접속 허용 기능(host 기반)

---

## Replication

### 1. Replica는 Source에 MySQL 사용자 계정으로 로그인

- Replication은 기본적으로 **Replica가 Source DB에 원격 접속하는 방식**
- Source에서 복제 계정을 생성

```sql
CREATE USER 'repl'@'%' IDENTIFIED BY 'xxx'; -- %: 접속하고자 하는 IP
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
```

- Replica는 생성한 계정으로 Source에 접속

```sql
CHANGE REPLICATION SOURCE TO
  SOURCE_HOST='192.168.0.xx', -- MySQL Source 서버가 운영되는 IP
  SOURCE_PORT=3306,
  SOURCE_USER='repl', --MySQL 접속 user
  SOURCE_PASSWORD='xxx'; -- MySQL 접속 user의 password
```

### 2. Replica는 두 가지 전용 스레드를 실행

✔ I/O Thread

- Source 서버에 접속 → `binlog` 파일을 읽어옴
- 읽은 내용을 로컬 `relay log` 파일로 저장

✔ SQL Thread

- `relay log`를 해석 → 실제 SQL 변경 내용 적용

### 3. Binlog 기반 전송 프로토콜

- MySQL은 Source 변경 사항을 `binlog`(binary log) 파일에 기록
- Replication은 이 `binlog`를 다음 경로로 전달:

```plain text
Source binlog → Replica I/O Thread → Relay Log → SQL Thread → Replica 데이터 적용
```
